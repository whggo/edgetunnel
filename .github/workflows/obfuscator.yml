name: Advanced Obfuscation and Commit

on:
    workflow_dispatch:
    schedule:
        - cron: '0 0 * * *'

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install javascript-obfuscator
        run: |
          npm install -g javascript-obfuscator@latest
          javascript-obfuscator --version

      - name: Generate config files
        run: |
          TIMESTAMP=$(date +%s)
          RANDOM_SUFFIX=$(openssl rand -hex 4)
          
          # ä¸»é…ç½®æ–‡ä»¶
          cat > obfuscate-config.json << EOF
          {
            "compact": true,
            "controlFlowFlattening": true,
            "controlFlowFlatteningThreshold": 0.$(( (TIMESTAMP % 30) + 70 )),
            "deadCodeInjection": true,
            "deadCodeInjectionThreshold": 0.$(( (TIMESTAMP % 30) + 40 )),
            "debugProtection": false,
            "disableConsoleOutput": false,
            "identifierNamesGenerator": "hexadecimal",
            "identifiersPrefix": "x${RANDOM_SUFFIX}",
            "log": false,
            "renameGlobals": true,
            "selfDefending": true,
            "splitStrings": true,
            "splitStringsChunkLength": $(( (TIMESTAMP % 8) + 5 )),
            "stringArray": true,
            "stringArrayEncoding": ["base64"],
            "stringArrayIndexShift": true,
            "stringArrayWrappersCount": $(( (TIMESTAMP % 3) + 1 )),
            "stringArrayWrappersChainedCalls": true,
            "stringArrayWrappersParametersMaxCount": $(( (TIMESTAMP % 8) + 3 )),
            "stringArrayThreshold": 0.$(( (TIMESTAMP % 40) + 40 )),
            "transformObjectKeys": true,
            "unicodeEscapeSequence": true,
            "numbersToExpressions": true,
            "simplify": true
          }
          EOF
          
          # å¤‡ç”¨é…ç½®æ–‡ä»¶
          cat > obfuscate-config-alt.json << EOF
          {
            "compact": true,
            "controlFlowFlattening": true,
            "controlFlowFlatteningThreshold": 0.85,
            "deadCodeInjection": true,
            "deadCodeInjectionThreshold": 0.35,
            "identifierNamesGenerator": "mangled",
            "renameGlobals": true,
            "selfDefending": true,
            "splitStrings": true,
            "splitStringsChunkLength": 10,
            "stringArray": true,
            "stringArrayEncoding": ["rc4"],
            "stringArrayThreshold": 0.75,
            "transformObjectKeys": true,
            "unicodeEscapeSequence": false
          }
          EOF
          
          echo "ç”Ÿæˆé…ç½®æ–‡ä»¶å®Œæˆ"

      - name: Obfuscate with dynamic config
        run: |
          if [ ! -f "æ˜æ–‡æºç .js" ]; then
            echo "âŒ æºæ–‡ä»¶ æ˜æ–‡æºç .js ä¸å­˜åœ¨"
            ls -la
            exit 1
          fi
          
          echo "ğŸ“ å¼€å§‹æ··æ·†ä¸»æ–‡ä»¶"
          javascript-obfuscator æ˜æ–‡æºç .js \
            --output _worker.js \
            --config obfuscate-config.json
          
          echo "// Obfuscated at $(date -u +"%Y-%m-%dT%H:%M:%SZ")" > temp.js
          cat _worker.js >> temp.js
          mv temp.js _worker.js

      - name: Create alternative variant
        run: |
          echo "ğŸ“ å¼€å§‹ç”Ÿæˆå¤‡ç”¨å˜ä½“"
          # ä½¿ç”¨é…ç½®æ–‡ä»¶è€Œä¸æ˜¯å‘½ä»¤è¡Œé€‰é¡¹
          javascript-obfuscator æ˜æ–‡æºç .js \
            --output _worker_alt.js \
            --config obfuscate-config-alt.json

      - name: Verify obfuscation results
        run: |
          echo "ğŸ” éªŒè¯æ··æ·†ç»“æœ:"
          if [ -s "_worker.js" ]; then
            echo "âœ… _worker.js - å¤§å°: $(wc -c < _worker.js) bytes, è¡Œæ•°: $(wc -l < _worker.js)"
            echo "ğŸ“Š æ–‡ä»¶ç‰¹å¾: $(file _worker.js)"
          else
            echo "âŒ _worker.js ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          if [ -s "_worker_alt.js" ]; then
            echo "âœ… _worker_alt.js - å¤§å°: $(wc -c < _worker_alt.js) bytes, è¡Œæ•°: $(wc -l < _worker_alt.js)"
            echo "ğŸ“Š æ–‡ä»¶ç‰¹å¾: $(file _worker_alt.js)"
          else
            echo "âš ï¸  _worker_alt.js ç”Ÿæˆå¤±è´¥"
          fi

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --name-only --exit-code; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œå‡†å¤‡æäº¤"
            
            COMMIT_MESSAGES=(
              "chore: update obfuscated worker script"
              "build: optimize worker bundle"
              "refactor: improve code protection"
              "security: enhance script obfuscation"
              "perf: update worker implementation"
            )
            RANDOM_INDEX=$(( RANDOM % ${#COMMIT_MESSAGES[@]} ))
            SELECTED_MSG="${COMMIT_MESSAGES[$RANDOM_INDEX]}"
            
            git add _worker.js _worker_alt.js
            git commit -m "${SELECTED_MSG} - $(date +%Y%m%d%H%M%S)"
            
            echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
            git push origin HEAD:${{ github.ref }}
          fi

      - name: Cleanup temporary files
        run: |
          rm -f obfuscate-config.json obfuscate-config-alt.json
          echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: Generate summary
        if: always()
        run: |
          echo "### ğŸ”’ æ··æ·†å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç”Ÿæˆæ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
          if [ -f "_worker.js" ]; then
            echo "- âœ… \`_worker.js\` - $(wc -l < _worker.js) è¡Œ, $(wc -c < _worker.js) å­—èŠ‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ \`_worker.js\` - ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "_worker_alt.js" ]; then
            echo "- âœ… \`_worker_alt.js\` - $(wc -l < _worker_alt.js) è¡Œ, $(wc -c < _worker_alt.js) å­—èŠ‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ \`_worker_alt.js\` - ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ··æ·†ç‰¹æ€§:**" >> $GITHUB_STEP_SUMMARY
          echo "- æ§åˆ¶æµå¹³å¦åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- å­—ç¬¦ä¸²æ•°ç»„ç¼–ç  (Base64 + RC4)" >> $GITHUB_STEP_SUMMARY
          echo "- æ­»ä»£ç æ³¨å…¥" >> $GITHUB_STEP_SUMMARY
          echo "- å…¨å±€å˜é‡é‡å‘½å" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªä¿æŠ¤ä»£ç " >> $GITHUB_STEP_SUMMARY
          echo "- å­—ç¬¦ä¸²åˆ†å‰²" >> $GITHUB_STEP_SUMMARY
          echo "- åŠ¨æ€é…ç½®å‚æ•°" >> $GITHUB_STEP_SUMMARY
