name: Advanced Obfuscation and Commit

on:
    workflow_dispatch:
    # å¯é€‰çš„å®šæ—¶è§¦å‘ï¼Œå¢åŠ éšæœºæ€§
    schedule:
        - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œ

jobs:
  obfuscate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          # ç§»é™¤ cache é…ç½®ï¼Œé¿å…é”æ–‡ä»¶é”™è¯¯

      - name: Install javascript-obfuscator
        run: |
          # ç›´æ¥å…¨å±€å®‰è£…ï¼Œä¸ä¾èµ–æœ¬åœ°åŒ…ç®¡ç†
          npm install -g javascript-obfuscator@latest
          # éªŒè¯å®‰è£…
          javascript-obfuscator --version

      - name: Generate unique obfuscation config
        run: |
          # ç”Ÿæˆéšæœºç‰¹å¾å‚æ•°
          TIMESTAMP=$(date +%s)
          RANDOM_SUFFIX=$(openssl rand -hex 4)
          
          # åˆ›å»ºåŠ¨æ€é…ç½®æ–‡ä»¶
          cat > obfuscate-config.json << EOF
          {
            "compact": true,
            "controlFlowFlattening": true,
            "controlFlowFlatteningThreshold": 0.$(( (TIMESTAMP % 30) + 70 )),
            "deadCodeInjection": true,
            "deadCodeInjectionThreshold": 0.$(( (TIMESTAMP % 30) + 40 )),
            "debugProtection": false,
            "disableConsoleOutput": false,
            "identifierNamesGenerator": "hexadecimal",
            "identifiersPrefix": "x${RANDOM_SUFFIX}",
            "log": false,
            "renameGlobals": true,
            "rotateStringArray": true,
            "selfDefending": true,
            "shuffleStringArray": true,
            "splitStrings": true,
            "splitStringsChunkLength": $(( (TIMESTAMP % 8) + 5 )),
            "stringArray": true,
            "stringArrayEncoding": ["base64"],
            "stringArrayIndexShift": true,
            "stringArrayWrappersCount": $(( (TIMESTAMP % 3) + 1 )),
            "stringArrayWrappersChainedCalls": true,
            "stringArrayWrappersParametersMaxCount": $(( (TIMESTAMP % 8) + 3 )),
            "stringArrayThreshold": 0.$(( (TIMESTAMP % 40) + 40 )),
            "transformObjectKeys": true,
            "unicodeEscapeSequence": true,
            "numbersToExpressions": true,
            "simplify": true
          }
          EOF
          
          echo "Generated config with timestamp: $TIMESTAMP"
          cat obfuscate-config.json

      - name: Obfuscate with dynamic config
        run: |
          # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "æ˜æ–‡æºç .js" ]; then
            echo "âŒ æºæ–‡ä»¶ æ˜æ–‡æºç .js ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la
            exit 1
          fi
          
          echo "ğŸ“ å¼€å§‹æ··æ·†æ–‡ä»¶: æ˜æ–‡æºç .js"
          javascript-obfuscator æ˜æ–‡æºç .js \
            --output _worker.js \
            --config obfuscate-config.json
          
          # æ·»åŠ æ—¶é—´æˆ³æ³¨é‡Š
          echo "// Obfuscated at $(date -u +"%Y-%m-%dT%H:%M:%SZ")" > temp.js
          cat _worker.js >> temp.js
          mv temp.js _worker.js

      - name: Create alternative variant
        run: |
          # ç”Ÿæˆç¬¬äºŒä¸ªå˜ä½“ï¼Œä½¿ç”¨ä¸åŒçš„é…ç½®
          javascript-obfuscator æ˜æ–‡æºç .js \
            --output _worker_alt.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.85 \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.35 \
            --identifier-names-generator "mangled" \
            --rename-globals true \
            --string-array true \
            --string-array-encoding "rc4" \
            --string-array-threshold 0.75 \
            --transform-object-keys true \
            --unicode-escape-sequence false \
            --rotate-string-array true \
            --self-defending true

      - name: Verify obfuscation results
        run: |
          echo "ğŸ” éªŒè¯æ··æ·†ç»“æœ:"
          if [ -s "_worker.js" ]; then
            echo "âœ… _worker.js - å¤§å°: $(wc -c < _worker.js) bytes, è¡Œæ•°: $(wc -l < _worker.js)"
          else
            echo "âŒ _worker.js ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          if [ -s "_worker_alt.js" ]; then
            echo "âœ… _worker_alt.js - å¤§å°: $(wc -c < _worker_alt.js) bytes, è¡Œæ•°: $(wc -l < _worker_alt.js)"
          else
            echo "âš ï¸  _worker_alt.js ç”Ÿæˆå¤±è´¥"
          fi

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if git diff --quiet --exit-code; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æäº¤ä¿¡æ¯æ•°ç»„
          COMMIT_MESSAGES=(
            "chore: update obfuscated worker script"
            "build: optimize worker bundle"
            "refactor: improve code protection"
            "security: enhance script obfuscation"
            "perf: update worker implementation"
          )
          RANDOM_INDEX=$(( RANDOM % ${#COMMIT_MESSAGES[@]} ))
          SELECTED_MSG="${COMMIT_MESSAGES[$RANDOM_INDEX]}"
          
          git add _worker.js _worker_alt.js
          git commit -m "${SELECTED_MSG} - $(date +%Y%m%d%H%M%S)"
          
          echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
          git push origin HEAD:${{ github.ref }}

      - name: Cleanup temporary files
        run: |
          rm -f obfuscate-config.json
          echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      - name: Generate summary
        if: always()
        run: |
          echo "### ğŸ”’ æ··æ·†å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç”Ÿæˆæ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`_worker.js\` - ä¸»æ··æ·†æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- \`_worker_alt.js\` - å¤‡ç”¨å˜ä½“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ··æ·†ç‰¹æ€§:**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… æ§åˆ¶æµå¹³å¦åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å­—ç¬¦ä¸²æ•°ç»„ç¼–ç " >> $GITHUB_STEP_SUMMARY
          echo "âœ… æ­»ä»£ç æ³¨å…¥" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å…¨å±€å˜é‡é‡å‘½å" >> $GITHUB_STEP_SUMMARY
          echo "âœ… è‡ªä¿æŠ¤ä»£ç " >> $GITHUB_STEP_SUMMARY
          echo "âœ… åŠ¨æ€é…ç½®å‚æ•°" >> $GITHUB_STEP_SUMMARY
